<div class="container-fluid">
    <div id="chats">
        <div class="container-fluid">
            <div class="card">
                <div class="card-header text-white bg-primary">
                    Centro de Mensages <span id="compress"></span>
                </div>
                <div class="card-body">
                    <div class="alert alert-dark" role="alert">
                        Bienvenido {{username}} <span style="float: right"> <a href="/logout">Desloguear</a></span>
                    </div>
                    <form class="form-horizontal" method="POST" action="/api/messages" id="chat">
                        <div class="form-group row">
                            <input required type="text" placeholder="ingrese el mensage" class="form-control col-6"
                                name="message" />
                        </div>
                        <div class="form-group row">
                            <input required class="btn btn-primary" type="submit" name="enviar" value="Enviar">
                        </div>
                    </form>
                    <p>Mensajes</p>
                    <ul style="list-style-type: none;" id="messages">
                    </ul>
                </div>
            </div>
        </div>
    </div>


</div>
<script>
    $(document).ready(() => {
        fetch('/api/messages')
            .then(response => response.json())
            .then(data => {
                const Author = new normalizr.schema.Entity("authors")
                const Message = new normalizr.schema.Entity("message")
                const Messages = [Message];
                const denorm = normalizr.denormalize(data.result, Messages, data.entities)
                const tamaNorm = JSON.stringify(data).length
                const tamaOrig = JSON.stringify(denorm).length
                const compress = (tamaNorm * 100 / tamaOrig).toFixed(2);
                $("#compress").text(`(CompresiÃ³n: ${compress}%)`)
                denorm.forEach(msg => {
                    const fecha = new Date(msg.fecha);
                    $("#messages").append(`
                    <li>
                        <span style="margin: 1px;color:blue">${msg.author}</span><span
                        style="margin: 1px; color:red">[${fecha.toLocaleDateString()} ${fecha.toLocaleTimeString()}]</span>
                        <span style="margin: 1px; color:green">: ${msg.text}</span>
                    </li>
            `)
                }
                )
            })
            .catch((ex) => console.error(ex));
    })
    $("#chat").on("submit", (e) => {
        let msg = {
            message: e.target[6].value
        }
        if (!msg.message) {
            alert("Complete los campos!");
            return false;
        }
    })
</script>